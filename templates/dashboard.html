<!doctype html>
<html lang="en">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  </head>
  <body>
    <div class='header'>
      <button type="button">Start</button>
    </div>
    <div class="container text-center">
      <div class="row">
        <div class="col">
          <div>
            <canvas id="latLong"></canvas>
          </div>
        </div>
        <div class="col">
          <div>
            <canvas id="headingBearing"></canvas>
          </div>
        </div>
        <div class="col">
          <div>
            <canvas id="rangeFt"></canvas>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div>
            <canvas id="airGroundSpeed"></canvas>
          </div>
        </div>
        <div class="col">
          <div>
            <canvas id="thetaPhi"></canvas>
          </div>
        </div>
        <div class="col">
          <div>
            <canvas id="gpsBaroAlt"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
      const socket = io.connect('http://127.0.0.1:5000');

      let charts = {
        latLong: false,
        headingBearing: false,
        rangeFt: false,
        airGroundSpeed: false,
        thetaPhi: false,
        gpsBaroAlt: false
      }

      const dataLength = 20;


      const addData = (chart, label, data) => {
        // chart.data.labels.push(label);
        chart.data.datasets.forEach((dataset) => {
            dataset.data.push(data);
        });

        // if (chart.data.labels.length >= 11)  chart.data.labels.shift();
        if (chart.data.datasets[0].data.length >= 11) chart.data.datasets.forEach((dataset) => dataset.data.shift());

        chart.update();
      };

      
      const latLong = () => {      
        
      }

      const headingBearing = (local_time, heading_deg, bearing_deg) => {
        if(!charts.headingBearing) {
          //console.log('charts.headingBearing created', headingBearing)
          charts.headingBearing = new Chart(document.getElementById('headingBearing'), {
            type: 'line',
            data: {
              datasets: [
                { label: 'Heading' },
                { label: 'Bearing' }
              ]
            },
            options: { animation: false }
          });
          //console.log('charts.headingBearing after', charts.headingBearing)
        } else {
          //console.log('charts.headingBearing', charts.headingBearing);
          charts.headingBearing.data.labels.push(local_time);
          if (charts.headingBearing.data.labels.length > dataLength)  charts.headingBearing.data.labels.shift();

          //console.log('charts.data.datasets',  charts.headingBearing.data.datasets[0].data)
          charts.headingBearing.data.datasets[0].data.push(heading_deg)
          if (charts.headingBearing.data.datasets[0].data.length > dataLength) charts.headingBearing.data.datasets[0].data.shift();

          //console.log('charts.data.datasets', charts.headingBearing.data.datasets[1].data)
          charts.headingBearing.data.datasets[1].data.push(bearing_deg)
          if (charts.headingBearing.data.datasets[1].data.length > dataLength) charts.headingBearing.data.datasets[1].data.shift();
        }
        // update data
        charts.headingBearing.update();
      }

      const rangeFt = (local_time, range_ft) => {
        if (!charts.rangeFt) {
          //console.log('charts.rangeFt created', rangeFt)
          charts.rangeFt = new Chart(document.getElementById('rangeFt'), {
            type: 'line',
            data: {
              datasets: [
                { label: 'Range Feet' },
              ]
            },
            options: { animation: false }
          });
          //console.log('charts.rangeFt after', charts.rangeFt)
        } else {
          //console.log('charts.rangeFt', charts.rangeFt);
          charts.rangeFt.data.labels.push(local_time);
          if (charts.rangeFt.data.labels.length > dataLength) charts.rangeFt.data.labels.shift();

          //console.log('charts.data.datasets',  charts.rangeFt.data.datasets[0].data)
          charts.rangeFt.data.datasets[0].data.push(range_ft)
          if (charts.rangeFt.data.datasets[0].data.length > dataLength) charts.rangeFt.data.datasets[0].data.shift();
        }
        // update data
        charts.rangeFt.update();
      }

      const airGroundSpeed = (local_time, airspeed_fps, groundspeed_fps) => {
        if (!charts.airGroundSpeed) {
          //console.log('charts.airGroundSpeed created', airGroundSpeed)
          charts.airGroundSpeed = new Chart(document.getElementById('airGroundSpeed'), {
            type: 'line',
            data: {
              datasets: [
                { label: 'Air Speed' },
                { label: 'Ground Speed' }
              ]
            },
            options: { animation: false }
          });
          //console.log('charts.airGroundSpeed after', charts.airGroundSpeed)
        } else {
          //console.log('charts.airGroundSpeed', charts.airGroundSpeed);
          charts.airGroundSpeed.data.labels.push(local_time);
          if (charts.airGroundSpeed.data.labels.length > dataLength) charts.airGroundSpeed.data.labels.shift();

          //console.log('charts.data.datasets',  charts.airGroundSpeed.data.datasets[0].data)
          charts.airGroundSpeed.data.datasets[0].data.push(airspeed_fps)
          if (charts.airGroundSpeed.data.datasets[0].data.length > dataLength) charts.airGroundSpeed.data.datasets[0].data.shift();

          //console.log('charts.data.datasets', charts.airGroundSpeed.data.datasets[1].data)
          charts.airGroundSpeed.data.datasets[1].data.push(groundspeed_fps)
          if (charts.airGroundSpeed.data.datasets[1].data.length > dataLength) charts.airGroundSpeed.data.datasets[1].data.shift();
        }
        // update data
        charts.airGroundSpeed.update();
      }

      const thetaPhi = (local_time, theta_deg, phi_deg) => {
        if (!charts.thetaPhi) {
          //console.log('charts.thetaPhi created', thetaPhi)
          charts.thetaPhi = new Chart(document.getElementById('thetaPhi'), {
            type: 'line',
            data: {
              datasets: [
                { label: 'theta_deg' },
                { label: 'phi_deg' }
              ]
            },
            options: { animation: false }
          });
          //console.log('charts.thetaPhi after', charts.thetaPhi)
        } else {
          //console.log('charts.thetaPhi', charts.thetaPhi);
          charts.thetaPhi.data.labels.push(local_time);
          if (charts.thetaPhi.data.labels.length > dataLength) charts.thetaPhi.data.labels.shift();

          //console.log('charts.data.datasets',  charts.thetaPhi.data.datasets[0].data)
          charts.thetaPhi.data.datasets[0].data.push(theta_deg)
          if (charts.thetaPhi.data.datasets[0].data.length > dataLength) charts.thetaPhi.data.datasets[0].data.shift();

          //console.log('charts.data.datasets', charts.thetaPhi.data.datasets[1].data)
          charts.thetaPhi.data.datasets[1].data.push(phi_deg)
          if (charts.thetaPhi.data.datasets[1].data.length > dataLength) charts.thetaPhi.data.datasets[1].data.shift();
        }
        // update data
        charts.thetaPhi.update();
      }

      const gpsBaroAlt = (local_time, gps_altitude_ft, baro_altitude_ft) => {
        if (!charts.gpsBaroAlt) {
          //console.log('charts.gpsBaroAlt created', gpsBaroAlt)
          charts.gpsBaroAlt = new Chart(document.getElementById('gpsBaroAlt'), {
            type: 'line',
            data: {
              datasets: [
                { label: 'gps_altitude_ft' },
                { label: 'baro_altitude_ft' }
              ]
            },
            options: { animation: false }
          });
          //console.log('charts.gpsBaroAlt after', charts.gpsBaroAlt)
        } else {
          //console.log('charts.gpsBaroAlt', charts.gpsBaroAlt);
          charts.gpsBaroAlt.data.labels.push(local_time);
          if (charts.gpsBaroAlt.data.labels.length > dataLength) charts.gpsBaroAlt.data.labels.shift();

          //console.log('charts.data.datasets',  charts.gpsBaroAlt.data.datasets[0].data)
          charts.gpsBaroAlt.data.datasets[0].data.push(gps_altitude_ft)
          if (charts.gpsBaroAlt.data.datasets[0].data.length > dataLength) charts.gpsBaroAlt.data.datasets[0].data.shift();

          //console.log('charts.data.datasets', charts.gpsBaroAlt.data.datasets[1].data)
          charts.gpsBaroAlt.data.datasets[1].data.push(baro_altitude_ft)
          if (charts.gpsBaroAlt.data.datasets[1].data.length > dataLength) charts.gpsBaroAlt.data.datasets[1].data.shift();
        }
        // update data
        charts.gpsBaroAlt.update();
      }

      socket.on("data", (data) => {
        /// we have useful data now
        const { local_time, heading_deg, bearing_deg, range_ft, airspeed_fps, groundspeed_fps, theta_deg, phi_deg, gps_altitude_ft, baro_altitude_ft } = data;
        console.log(data);

        headingBearing(local_time, heading_deg, bearing_deg);
        rangeFt(local_time, range_ft);
        airGroundSpeed(local_time, airspeed_fps, groundspeed_fps);
        thetaPhi(local_time, theta_deg, phi_deg);
        gpsBaroAlt(local_time, gps_altitude_ft, baro_altitude_ft);
        
    //     'lat' : data[0],
    // 'lon' : data[1],
    // 'heading_deg' : data[2],
    // 'bearing_deg' : data[3],
    // 'range_ft' : data[4],
    // 'target_lat' : data[5],
    // 'target_lon' : data[6],
    // 'airspeed_fps' : data[7],
    // 'groundspeed_fps' : data[8],
    // 'theta_deg' : data[9],
    // 'phi_deg' : data[10],
    // 'gps_altitude_ft' : data[11],
    // 'baro_altitude_ft' : data[12],
    // 'bat_voltage_V' : data[13],
    // 'local_time' : data[14],
    // 'time_recorded' : data[15],
    // 'sound_bit' : data[16],
      });
    </script>
  </body>
</html>